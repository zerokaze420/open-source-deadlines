name: Lint Data Files

on:
  pull_request:
    paths:
      - 'data/**.yml'
      - 'data/**.yaml'
  push:
    branches:
      - '*'
  workflow_dispatch:

jobs:
  lint-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML python-dateutil pytz

      - name: Run data validation script and capture output
        id: validation
        run: |
          # è¿è¡Œè„šæœ¬ï¼Œåˆå¹¶ stdout/stderr åˆ° output.log
          python scripts/check_data.py > output.log 2>&1

          # æå–è­¦å‘Šå’Œé”™è¯¯
          grep "^Warning:" output.log > warnings.txt || true
          grep "^Error:" output.log > errors.txt || true

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "has_warnings=$( [ -s warnings.txt ] && echo true || echo false )" >> $GITHUB_OUTPUT
          echo "has_errors=$( [ -s errors.txt ] && echo true || echo false )" >> $GITHUB_OUTPUT

          # è°ƒè¯•ï¼šæ‰“å°æ‘˜è¦ï¼ˆå¯é€‰ï¼‰
          echo "Warnings: $(wc -l < warnings.txt || echo 0)"
          echo "Errors: $(wc -l < errors.txt || echo 0)"
        continue-on-error: true  # å…è®¸è„šæœ¬å¤±è´¥ï¼Œä»¥ä¾¿æˆ‘ä»¬å¤„ç†è¾“å‡º

      - name: Print validation results to log
        if: always()
        run: |
          echo "=== VALIDATION OUTPUT ==="
          cat output.log
          echo "=========================="

      - name: Comment on PR with validation results
        if: github.event_name == 'pull_request' && (steps.validation.outputs.has_warnings == 'true' || steps.validation.outputs.has_errors == 'true')
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs').promises;

            let messages = [];

            try {
              const warnings = await fs.readFile('warnings.txt', 'utf8');
              if (warnings.trim()) {
                messages.push(`âš ï¸ **Warnings**:\n\`\`\`\n${warnings.trim()}\n\`\`\``);
              }
            } catch (e) {
              // warnings.txt may not exist or be empty
            }

            try {
              const errors = await fs.readFile('errors.txt', 'utf8');
              if (errors.trim()) {
                messages.push(`âŒ **Errors**:\n\`\`\`\n${errors.trim()}\n\`\`\``);
              }
            } catch (e) {
              // errors.txt may not exist or be empty
            }

            if (messages.length === 0) return;

            const prNumber = context.payload.pull_request.number;
            const commentBody = `## ğŸ“‹ Data Validation Report\n\n${messages.join('\n\n')}\n\n> â„¹ï¸ This comment is automatically generated by the **Lint Data Files** workflow.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Fail CI if there are validation errors
        if: steps.validation.outputs.has_errors == 'true'
        run: exit 1