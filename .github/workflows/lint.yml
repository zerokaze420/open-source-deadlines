name: Lint Data Files

on:
  pull_request:
    paths:
      - 'data/**.yml'
      - 'data/**.yaml'
  push:
    branches:
      - '*'
  workflow_dispatch:

jobs:
  lint-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML python-dateutil pytz

      - name: Run data validation script and capture output
        id: validation
        run: |
          # Run script and capture all output
          python scripts/check_data.py > output.log 2>&1
          script_exit_code=$?

          # Extract warnings and errors by prefix
          grep "^Warning:" output.log > warnings.txt || true
          grep "^Error:" output.log > errors.txt || true

          # Set step outputs for later use
          echo "has_warnings=$( [ -s warnings.txt ] && echo true || echo false )" >> $GITHUB_OUTPUT
          echo "has_errors=$( [ -s errors.txt ] && echo true || echo false )" >> $GITHUB_OUTPUT

          # Optional: log counts
          echo "Warnings: $(wc -l < warnings.txt || echo 0)"
          echo "Errors: $(wc -l < errors.txt || echo 0)"

          # IMPORTANT: Always exit 0 so subsequent steps can read outputs
          exit 0

      - name: Print validation results to log
        if: always()
        run: |
          echo "=== VALIDATION OUTPUT ==="
          cat output.log
          echo "=========================="

      - name: Comment on PR with validation results
        if: github.event_name == 'pull_request' && (steps.validation.outputs.has_warnings == 'true' || steps.validation.outputs.has_errors == 'true')
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs').promises;
            let messages = [];

            try {
              const warnings = await fs.readFile('warnings.txt', 'utf8');
              if (warnings.trim()) {
                messages.push(`‚ö†Ô∏è **Warnings**:\n\`\`\`\n${warnings.trim()}\n\`\`\``);
              }
            } catch (e) {
              // Ignore if file missing
            }

            try {
              const errors = await fs.readFile('errors.txt', 'utf8');
              if (errors.trim()) {
                messages.push(`‚ùå **Errors**:\n\`\`\`\n${errors.trim()}\n\`\`\``);
              }
            } catch (e) {
              // Ignore if file missing
            }

            if (messages.length === 0) return;

            const prNumber = context.payload.pull_request.number;
            const commentBody = `## üìã Data Validation Report\n\n${messages.join('\n\n')}\n\n> ‚ÑπÔ∏è This comment is automatically generated by the **Lint Data Files** workflow.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Fail CI if there are validation errors
        if: steps.validation.outputs.has_errors == 'true'
        run: exit 1